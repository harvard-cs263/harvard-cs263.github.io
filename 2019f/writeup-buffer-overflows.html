<!DOCTYPE html><html><head><meta charset="utf-8"><title></title><style type="text/css">/******************************************************************************
The MIT License (MIT)

Copyright (c) 2014 Matthias Eisen

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
******************************************************************************/

/* Modified by Jerry Ma */

body {
    font-family: Palatino, "Palatino LT STD", "Palatino Linotype", "Book Antiqua", Georgia, serif;
    font-size: 16px;
    color: #24292e;
}

div.document {
    margin: 0 auto;
    width: 95%;
    max-width: 960px;
}

p {
    line-height: 120%;
}


/* ========== Headings ========== */

h1, h2, h3, h4, h5, h6 {
    font-weight: normal;
    margin-top: 1.5em;
}

h1.section-subtitle, 
h2.section-subtitle, 
h3.section-subtitle,
h4.section-subtitle, 
h5.section-subtitle, 
h6.section-subtitle {
    margin-top: 0.4em;
}

h1.title {
    text-align: center;
}

h2.subtitle {
    text-align: center;
}

span.section-subtitle {
    font-size: 80%,
}

/* //-------- Headings ---------- */


/* ========== Images ========== */

img, 
.figure, 
object {
    display:        block;
    margin-left:    auto;
    margin-right:   auto;
}

div.figure {
    margin-left:    2em;
    margin-right:   2em;
}

img.align-left, .figure.align-left, object.align-left {
    clear:          left;
    float:          left;
    margin-right:   1em;
}

img.align-right, .figure.align-right, object.align-right {
    clear:          right;
    float:          right;
    margin-left:    1em;
}

img.align-center, .figure.align-center, object.align-center {
    display:        block;
    margin-left:    auto;
    margin-right:   auto;
}

/* reset inner alignment in figures */
div.align-right {
    text-align: inherit;
}

object[type="image/svg+xml"], 
object[type="application/x-shockwave-flash"] {
    overflow: hidden;
}

/* //-------- Images ---------- */



/* ========== Literal Blocks ========== */

pre, tt.literal, span.literal {
    font-family: "Lucida Sans Typewriter", "Lucida Console", Monaco, "Bitstream Vera Sans Mono", monospace;
    font-size: 14px;
}

tt.literal {
    background-color: #ffa;
}

span.literal {
    background-color: #f3f3f4;
    border-radius: 0.3em;
    padding-left: 0.3em;
    padding-right: 0.3em;
    white-space: pre;
}

pre.address {
    margin-bottom: 0;
    margin-top: 0;
    font: inherit;
}

pre.literal-block {
    border-left: solid 5px #ccc;
    background-color: #f6f8fa;
    padding: 1em;
}

pre.literal-block, pre.doctest-block, pre.math, pre.code {
}

span.interpreted {
}

span.pre {
    white-space: pre;
}

pre.code .ln { 
    color: grey; 
}
pre.code, code {
    border-style: none;
    padding: 1em 0;
}
pre.code .comment, code .comment { 
    color: #888;
}
pre.code .keyword, code .keyword {
    font-weight: bold; 
    color: #080;
}
pre.code .literal.string, code .literal.string { 
    color: #d20;
    background-color: #fff0f0;
}
pre.code .literal.number, code .literal.number { 
    color: #00d;
}
pre.code .name.builtin, code .name.builtin {
    color: #038;
    color: #820;
}
pre.code .name.namespace, code .name.namespace {
    color: #b06;
}
pre.code .deleted, code .deleted {
    background-color: #fdd;
}
pre.code .inserted, code .inserted {
    background-color: #dfd;
}


/* //-------- Literal Blocks --------- */


/* ========== Tables ========== */

table {
    border-spacing:         0;
    border-collapse:        collapse;
    border-style:           none;
    border-top:             solid 1px #111;
    border-bottom:          solid 1px #111;
}

td, 
th {
    border: none;
    padding-left: 0.8em;
    padding-right: 0.8em;
    vertical-align:         top;
}

th {
    border-top:             solid 1px #111;
    border-bottom:          solid 1px #111;
    background-color:       #ddd;
}

td p {
    margin: 0;
    padding: 0;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

table.field-list,
table.footnote,
table.citation,
table.option-list {
    border:                 none;
}
table.docinfo {
    margin:                 2em 4em;
}

table.docutils {
    margin:                 1em 0;
}

table.docutils th.field-name, 
table.docinfo th.docinfo-name {
    border:                 none;
    background:             none;
    font-weight:            bold ;
    text-align:             left ;
    white-space:            nowrap ;
    padding-left:           0;
    vertical-align:         middle; 
}

table.docutils.booktabs {
    border:                 none;
    border-top:             2px solid;
    border-bottom:          2px solid;
    border-collapse:        collapse;
}

table.docutils.booktabs * {
    border:                 0px;
}
table.docutils.booktabs th {
    border-bottom:          thin solid;
    text-align:             left;
}

span.option {
    white-space: nowrap;
}

table caption {
    margin-bottom: 2px;
}

/* //-------- Tables ---------- */


/* ========== Lists ========== */

ol.simple, ul.simple {
    margin-bottom: 1em;
}

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl.docutils dd {
    margin-bottom: 0.5em;
}


dl.docutils dt {
    font-weight: bold;
}

li p {
    margin: 0;
    padding: 0;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

dl {
    margin: 0;
    padding: 0;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

/* //-------- Lists ---------- */


/* ========== Sidebar ========== */

div.sidebar {
    margin: 0 0 0.5em 1em ;
    border-left: solid 2px #111;
    padding: 1em ;
    width: 40% ;
    float: right ;
    clear: right;
}

div.sidebar {
    font-size: 14px;
}

p.sidebar-title {
    font-size: 16px;
    font-weight: bold ;
}

p.sidebar-subtitle {
    font-weight: bold;
}

/* //-------- Sidebar ---------- */


/* ========== Topic ========== */

div.topic {
    margin: 2em;
    padding: 1em 0;
    border-width: 1px;
    border-color: #111;
    border-style: solid none;
}

div.topic p {
    padding: 0;
}

p.topic-title {
    font-weight: bold;
}

/* //-------- Topic ---------- */


/* ========== Header ========== */

div.header {
    font-family:        "Century Gothic", CenturyGothic, Geneva, AppleGothic, sans-serif;
    font-size:          14px;
    margin:             2em auto 4em auto;
    max-width:          960px;
    clear:              both;
}

hr.header {
    border:             0;
    height:             1px;
    margin-top:         1em;
    background-color:   #111;
}

/* //-------- Header ---------- */


/* ========== Footer ========== */

div.footer {
    font-family:        "Century Gothic", CenturyGothic, Geneva, AppleGothic, sans-serif;
    font-size:          14px;
    margin:             6em auto 2em auto;
    max-width:          960px;
    clear:              both;
    text-align:         center;
}

hr.footer {
    border:             0;
    height:             1px;
    margin-bottom:      2em;
    background-color:   #111;
}

/* //-------- Footer ---------- */


/* ========== Admonitions ========== */

div.admonition, 
div.attention, 
div.caution, 
div.danger, 
div.error,
div.hint, 
div.important, 
div.note, 
div.tip, 
div.warning {
    margin: 2em;
    border: solid 1px #111;
    padding: 0 1em;
    background-color: #eee;
}

div.error,
div.danger {
    border-color: #a94442;
    background-color: #f2dede;
}

div.hint,
div.tip {
    border-color: #31708f;
    background-color: #d9edf7;
}

div.attention,
div.caution,
div.warning {
    border-color: #8a6d3b;
    background-color: #fcf8e3; 
}

div.hint p.admonition-title,
div.tip p.admonition-title {
    color: #31708f;
    font-weight: bold ;
}

div.note p.admonition-title,
div.admonition p.admonition-title, 
div.important p.admonition-title {
    font-weight: bold ;
}

div.attention p.admonition-title,
div.caution p.admonition-title,
div.warning p.admonition-title {
    color: #8a6d3b;
    font-weight: bold ;
}

div.danger p.admonition-title, 
div.error p.admonition-title,
.code .error {
    color: #a94442;
    font-weight: bold ;
}

/* //-------- Admonitions ---------- */


/* ========== Table of Contents ========== */

div.contents {
    margin: 2em 0;
    border: none;
}

ul.auto-toc {
    list-style-type: none;
}

a.toc-backref {
    text-decoration: none ;
    color: #111;
}

/* //-------- Table of Contents ---------- */



/* ========== Line Blocks========== */

div.line-block {
    display: block ;
    margin-top: 1em ;
    margin-bottom: 1em;
}

div.line-block div.line-block {
    margin-top: 0 ;
    margin-bottom: 0 ;
    margin-left: 1.5em;
}

/* //-------- Line Blocks---------- */


/* ========== System Messages ========== */

div.system-messages {
    margin: 5em;
}

div.system-messages h1 {
    color: red;
}

div.system-message {
    border: medium outset ;
    padding: 1em;
}

div.system-message p.system-message-title {
    color: red ;
    font-weight: bold;
}

/* //-------- System Messages---------- */


/* ========== Helpers ========== */

.hidden {
    display: none;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both ;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* //-------- Helpers---------- */


p.caption {
    font-style: italic;
    text-align: center;
}

p.credits {
font-style: italic ;
font-size: smaller }

p.label {
white-space: nowrap }

p.rubric {
font-weight: bold ;
font-size: larger ;
color: maroon ;
text-align: center }

p.attribution {
text-align: right ;
margin-left: 50% }

blockquote.epigraph {
    margin: 2em 5em;
}

div.abstract {
margin: 2em 5em }

div.abstract {
font-weight: bold ;
text-align: center }

div.dedication {
margin: 2em 5em ;
text-align: center ;
font-style: italic }

div.dedication {
font-weight: bold ;
font-style: normal }


span.classifier {
font-style: oblique }

span.classifier-delimiter {
font-weight: bold }

span.problematic {
color: red }



</style></head><body><h1>Buffer Overflows</h1><p>Copyright © 2017, Harvard University CS263 —
all rights reserved.</p><p>This project will give you hands-on experience with buffer overflow vulnerabilities, allowing you to attack a simple web server called zookws. The zookws web server is running a simple python web application, zoobar, in which users transfer "zoobars" (credits) between each other. You will find buffer overflows in the zookws web server code, write exploits for those buffer overflows, and look for other potential problems in the web server implementation.</p><section id="project-setup"><header><h2>Project Setup</h2></header><ul><li><p>Click on the provided GitHub Classroom assignment link, login via GitHub if necessary, and click "Accept assignment".</p></li><li><p>Login to the VM.</p></li><li><p><code>cd</code> to your home directory and run <code>git clone &lt;repo_url&gt; lab/</code> to clone your repo.</p></li><li><p>Run <code>cd lab/</code> to enter the project directory.</p></li><li><p>Run <code>./pre_setup.sh</code>.</p></li><li><p>Run <code>git checkout -b submission</code> to checkout your new branch.</p></li></ul><p>Refer to Project 0's writeup for elaboration on any of these steps.</p><div class="alert-message block-message warning"><p class="admonition-title">Caution</p><p>Before starting, remember the warning from Project 0:</p><p>It is important that you <strong>do not</strong> push directly to master. After committing, push using <code>git push origin submission</code> and open a pull request.</p></div><div class="alert-message block-message warning"><p class="admonition-title">Caution</p><p>As mentioned in Project 0's writeup, <strong>do not</strong> use <code>apt-get</code> and related commands yet. Installing, removing, or upgrading packages (esp. <code>lib*</code>) has the potential to change various things in your address space, so your code will probably fail tests on our grading machines.</p></div></section><section id="specification"><header><h2>Specification</h2></header><div class="alert-message block-message warning"><p class="admonition-title">Caution</p><p>For all projects, trying to modify or otherwise game the test cases will result in a grade of zero and academic dishonesty sanctions. Contact the course staff if you encounter issues with the tests.</p></div><section id="introduction"><header><h3>Introduction</h3></header><p>The files that you will need for this project should now reside in <code>~/lab</code>. Before you proceed with the project, compile the zookws webserver via <code>make</code>.</p><p>The zookws web server consists of the following components:</p><ul><li><p><code>zookld</code>, a launcher daemon that launches services configured in the file <code>zook.conf</code>.</p></li><li><p><code>zookd</code>, a dispatcher that routes HTTP requests to corresponding services.</p></li><li><p><code>zookfs</code> and other services that may serve static files or execute dynamic scripts.</p></li></ul><p>After <code>zookld</code> launches the configured services, <code>zookd</code> listens on a port (8080 by default) for incoming HTTP requests and reads the first line of each request for dispatching. In this lab, <code>zookd</code> is configured to dispatch every request to the <code>zookfs</code> service, which reads the rest of the request and generates a response from the requested file. Most HTTP-related code is in <code>http.c</code>. Here is a <a class="reference external" href="http://www.garshol.priv.no/download/text/http-tut.html">tutorial of the HTTP protocol</a>.</p><p>You will be using two versions of the web server:</p><ul><li><p><code>zookld</code>, <code>zookd-exstack</code>, <code>zookfs-exstack</code>, as configured in the file <code>zook-exstack.conf</code></p></li><li><p><code>zookld</code>, <code>zookd-nxstack</code>, <code>zookfs-nxstack</code>, as configured in the file <code>zook-nxstack.conf</code></p></li></ul><p>In the first version, the <code>*-exstack</code> binaries have an executable stack, which makes it easier to inject executable code using a stack buffer overflow. The <code>*-nxstack</code> binaries have a non-executable stack; you will write exploits that bypass non-executable stacks later in this lab assignment.</p><p>In order to run the web server in a predictable fashion---so that its stack and memory layout is the same every time---you will use the <code>clean-env.sh</code> script. This is the same way in which we will run the web server during grading, so make sure that all of your exploits work on this configuration!</p><p>The reference binaries of zookws are provided in <code>bin.tar.gz</code>. We will use those binaries for grading, so make sure that your exploits work on those binaries.</p><p>Now, make sure that you can run the zookws web server and start the application via <code>./clean-env.sh ./zookld zook-exstack.conf</code>. You should then be able to open your browser and go to <a class="reference external" href="http://192.168.26.3:8080/">http://192.168.26.3:8080/</a>. If something doesn't seem to be working, try to figure out what went wrong before proceeding further.</p></section><section id="gdb"><header><h3>GDB</h3></header><p>Using <code>gdb</code> is a critical part of this assignment. We strongly recommend that, before you start this assignment, you read this <a class="reference external" href="../resources/GDB-tutorial.pdf">GDB tutorial</a>!</p></section><section id="part-1-finding-buffer-overflows"><header><h3>Part 1: Finding Buffer Overflows</h3></header><p>In the first part of this lab assignment, you will find buffer overflows in the provided web server. Read Aleph One's article, "Smashing the Stack for Fun and Profit", as well as "Buffer Overflows: Attacks and Defenses for the Vulnerability of the Decade" (<code>articles/stack_smashing.txt</code> and <code>articles/buffer_overflows.pdf</code> in the repository, respectively), to figure out how buffer overflows work.</p><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>Since the repository lives on your VM and <code>scp</code> is a pain, it's probably easiest to download all files in <code>articles/</code> from the repo's GitHub page.</p></div><p>Study the web server's code, and find examples of code that is vulnerable to memory corruption via buffer overflows. Write down a description of each vulnerability in the file <code>bugs.txt</code>; use the format described in that file. For each vulnerability, describe the buffer which may overflow, how you would structure the input to the web server (i.e., the HTTP request) to overflow the buffer, and whether the vulnerability can be prevented using stack canaries. Locate at least 5 different vulnerabilities.</p><p><strong>Testing</strong>: <code>make test_bugs</code> will check if your <code>bugs.txt</code> file matches the required format. However, the command will not check whether the bugs that you listed are actual bugs (or whether your analysis of them is correct).</p></section><section id="part-2-memory-corruption"><header><h3>Part 2: Memory Corruption</h3></header><p>Now, you will start developing exploits to take advantage of the buffer overflows that you have found. We have provided template Python code for an exploit in <code>exploit_template.py</code>. That script issues an HTTP request, and takes two arguments, the server name and port number. So, you might run it as follows to issue a request to zookws running on localhost:</p><pre>httpd@vm263:~/lab$ ./clean-env.sh ./zookld zook-exstack.conf

(in another terminal session)
httpd@vm263:~/lab$ ./exploit_template.py localhost 8080
HTTP request:
GET / HTTP/1.0

...</pre><p>You are free to use this template, or write your own exploit code from scratch. Note, however, that if you choose to write your own exploit, the exploit must run correctly inside the provided virtual machine.</p><div class="alert-message block-message warning"><p class="admonition-title">Important</p><p>The exploit template is <strong>Python 3</strong> code. You may use Python 2.7 (if you do, be sure to change the first line's <code>python3</code> to <code>python2</code>), but you are on your own as we only officially support Python 3.</p></div><p>Pick two buffer overflows from the ones you put in <code>bugs.txt</code>. The first must overwrite a return address on the stack, and the second must overwrite some other data structure that you will use to take over the control flow of the program.</p><p>Then, write exploits that trigger them. For now, you do not need to inject code or do anything other than corrupt memory past the end of the buffer. Verify that your exploit actually corrupts memory, by either checking the last few lines of <code>dmesg | tail</code>, using <code>gdb</code>, or observing that the web server crashes.</p><p>Name these exploits <code>crash_1.py</code> and <code>crash_2.py</code>. In addition, answer the written questions in <code>crash.txt</code> (save your answers directly in the file).</p><p>If you believe that a vulnerability in <code>bugs.txt</code> is too difficult to exploit, choose a different one.</p><p><strong>Testing</strong>: <code>make test_crash_1</code> and <code>make test_crash_2</code> will check that your exploits crash the server via memory corruption (namely, a <code>SIGSEGV</code>). Note that this does <strong>not</strong> check <code>crash.txt</code>.</p><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>You will find <code>gdb</code> useful in building your exploits. As zookws forks off many processes, it can be difficult to debug the correct one. The easiest way to do this is to run the web server ahead of time with <code>clean-env.sh</code> and then attaching <code>gdb</code> to an already-running process with the <code>-p</code> flag. To help find the right process for debugging, zookld prints out the process IDs of the child processes that it spawns. You can also find the PID of a process by using pgrep; for example, to attach to <code>zookd-exstack</code>, start the server and, in another shell, run:</p><pre>httpd@vm-CS263:~/lab$ gdb -p $(pgrep zookd-exstack)
...
0x4001d422 in __kernel_vsyscall ()
(gdb) break your-breakpoint
Breakpoint 1 at 0x1234567: file zookd.c, line 999.
(gdb) continue
Continuing.</pre><p>Keep in mind that a process being debugged by <code>gdb</code> will not get killed even if you terminate the parent zookld process using <code>Ctrl-C</code>. If you are having trouble restarting the web server, check for leftover processes from the previous run, or be sure to exit <code>gdb</code> before restarting zookld.</p><p>When a process being debugged by <code>gdb</code> forks, by default <code>gdb</code> continues to debug the parent process and does not attach to the child. Since zookfs forks a child process to service each request, you may find it helpful to have <code>gdb</code> attach to the child on fork, using the command <code>set follow-fork-mode child</code>. We have added that command to <code>.gdbinit</code>, which will take effect if you start <code>gdb</code> in that directory.</p></div><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>For this and subsequent tasks, you may need to encode your attack payload in different ways, depending on which vulnerability you are exploiting. In some cases, you may need to make sure that your attack payload is URL-encoded, i.e.,, using <code>+</code> instead of space and <code>%2b</code> instead of <code>+</code>. Here is a <a class="reference external" href="http://www.blooberry.com/indexdot/html/topics/urlencoding.htm">URL encoding reference</a>. You can also use the quoting functions in the Python <a class="reference external" href="https://docs.python.org/3/library/urllib.html">urllib module</a> to URL-encode strings (see the exploit template for an example).</p><p>In other cases, you may need to include binary values into your payload. The Python <a class="reference external" href="https://docs.python.org/3/library/struct.html">struct module</a> can help you do that. For example, <code>struct.pack(b'&lt;I', x)</code> will produce a 4-byte (32-bit) little-endian binary encoding of the integer <code>x</code>.</p></div></section><section id="part-3-code-injection-via-buffer-overflow"><header><h3>Part 3: Code Injection via Buffer Overflow</h3></header><p>In this part, you will use your buffer overflows to inject code into the web server. The goal of the injected code will be to <code>unlink</code> (i.e., remove) a sensitive file on the server, namely <code>/home/httpd/grades.txt</code>. Use the <code>*-exstack</code> binaries (via configuration files, as discussed before), since they have an executable stack that makes it easier to inject code. The zookws web server should be started via <code>./clean-env.sh ./zookld zook-exstack.conf</code>.</p><section id="shell-code"><header><h4>Shell Code</h4></header><p>We have provided Aleph One's shell code for you to use in <code>shellcode.S</code>, along with <code>Makefile</code> rules that produce <code>shellcode.bin</code>, a compiled version of the shell code, when you run make. Aleph One's exploit is intended to exploit <code>setuid-root</code> binaries, and thus it runs a shell. You will need to modify this shell code to instead unlink <code>/home/httpd/grades.txt</code>. This part is ungraded, but you will most likely need <code>shellcode.bin</code> for your injection attack.</p><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>To help you develop your shell code for this task, we have provided a program called <code>run-shellcode</code> that will run your binary shell code, as if you correctly jumped to its starting point. For example, running it on Aleph One's shell code will cause the program to <code>execve("/bin/sh")</code>, thereby giving you another shell prompt:</p><pre>httpd@vm263:~/lab$ ./run-shellcode shellcode.bin
$</pre></div></section><section id="injection-attack"><header><h4>Injection Attack</h4></header><p>Starting from one of your memory corruption exploits, construct an exploit that hijacks control flow of the web server to unlink <code>/home/httpd/grades.txt</code>. Save this exploit in a file called <code>unlink_exstack.py</code>. In addition, answer the written questions in <code>unlink_exstack.txt</code> (save your answers directly in the file).</p><p>Verify that your exploit works; you will need to re-create <code>/home/httpd/grades.txt</code> after each successful exploit run.</p><div class="alert-message block-message warning"><p class="admonition-title">Important</p><p>It's OK to hardcode things -- however, you should be careful that your hardcoded things won't break when we're testing your code. This means, among other things, that your repository's root directory should be <code>/home/httpd/lab/</code>.</p></div><p><strong>Testing</strong>: <code>make test_unlink_exstack</code> will check that your exploit unlinks <code>/home/httpd/grades.txt</code> with an executable stack. Note that this does <strong>not</strong> check <code>unlink_exstack.txt</code>.</p><div class="alert-message block-message info" id="foostack"><p class="admonition-title">Tip</p><p>When developing an exploit, you will have to think about what values are on the stack, so that you can modify them accordingly. For your reference, here is what the stack frame of some function <code>foo()</code> looks like; here, <code>foo()</code> has a local variable <code>char buf[256]</code>:</p><pre>             +------------------+
             |       ...        |
             |  stack frame of  |
             |   foo's caller   |
             |       ...        |
             +------------------+
             |  return address  | (4 bytes)
             | to foo's caller  |
             +------------------+
%ebp ------&gt; |    saved %ebp    | (4 bytes)
             +------------------+
             |       ...        |
             +------------------+
             |     buf[255]     |
             |       ...        |
 buf ------&gt; |      buf[0]      |
             +------------------+</pre><p>Note that the stack grows down in this figure, and memory addresses are increasing up.</p></div><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>When developing an exploit, you will often need to know the addresses of specific stack locations, or specific functions, in a particular program. The easiest way to do this is to use <code>gdb</code>. For example, suppose you want to know the stack address of the <code>pn[]</code> array in the <code>http_serve()</code> function in <code>zookfs-exstack</code>, and the address of its saved <code>%ebp</code> register on the stack. You can obtain them using <code>gdb</code> as follows:</p><pre>httpd@vm-CS263:~/lab$ gdb -p $(pgrep zookfs-exstack)
...
0x40022416 in __kernel_vsyscall ()
(gdb) break http_serve
Breakpoint 1 at 0x8049415: file http.c, line 248.
(gdb) continue
Continuing.</pre><p>Be sure to run <code>gdb</code> from the <code>~/lab</code> directory, so that it picks up the <code>set follow-fork-mode child</code> command from <code>~/lab/.gdbinit</code>. Now you can issue an HTTP request to the web server, so that it triggers the breakpoint, and so that you can examine the stack of <code>http_serve()</code>:</p><pre>[New process 1339]
[Switching to process 1339]

Breakpoint 1, http_serve (fd=3, name=0x8051014 "/") at http.c:248
248     void (*handler)(int, const char *) = http_serve_none;
(gdb) print &amp;pn
$1 = (char (*)[1024]) 0xbfffd10c
(gdb) info registers
eax            0x3  3
ecx            0x400bdec0 1074519744
edx            0x6c6d74 7105908
ebx            0x804a38e  134521742
esp            0xbfffd0a0 0xbfffd0a0
ebp            0xbfffd518 0xbfffd518
esi            0x0  0
edi            0x0  0
eip            0x8049415  0x8049415 &lt;http_serve+9&gt;
eflags         0x200286 [ PF SF IF ID ]
cs             0x73 115
ss             0x7b 123
ds             0x7b 123
es             0x7b 123
fs             0x0  0
gs             0x33 51
(gdb)</pre><p>From this, you can tell that, at least for this invocation of <code>http_serve()</code>, the <code>pn[]</code> buffer on the stack lives at address <code>0xbfffd10c</code>, and the value of <code>%ebp</code> (which points at the saved <code>%ebp</code> on the stack) is <code>0xbfffd518</code>.</p></div><div class="alert-message block-message info"><p class="admonition-title">Hint</p><p>Here's a suggested plan of attack for this task:</p><p>First, focus on obtaining control of the program counter. Sketch out the stack layout that you expect the program to have at the point when you overflow the buffer, and use <code>gdb</code> to verify that your overflow data ends up where you expect it to. Step through the execution of the function to the return instruction to make sure you can control what address the program returns to. The <code>next</code>, <code>stepi</code>, <code>info reg</code>, and <code>disassemble</code> commands in <code>gdb</code> should prove helpful.</p><p>Once you can reliably hijack the control flow of the program, find a suitable address that will contain the code you want to execute, and focus on placing the correct code at that address (perhaps from <code>shellcode.bin</code>).</p><p>Note that <code>SYS_unlink</code>, the number of the unlink syscall, is 10 or <code>'\n'</code> (newline). Why does this complicate matters? How can you get around it?</p></div></section></section><section id="part-4-return-to-libc-attacks"><header><h3>Part 4: Return-to-libc Attacks</h3></header><p>Many modern operating systems mark the stack as non-executable in an attempt to make it more difficult to exploit buffer overflows. In this part, you will explore how this protection mechanism can be circumvented. You'll need to run the web server configured with binaries that have a non-executable stack via <code>./clean-env.sh ./zookld zook-nxstack.conf</code>.</p><p>Starting from your two memory corruption exploits, construct two additional exploits that unlink <code>/home/httpd/grades.txt</code> when run on the binaries that have a non-executable stack. Name these new exploits <code>unlink_libc_1.py</code> and <code>unlink_libc_2.py</code>. In addition, answer the written questions in <code>unlink_libc.txt</code> (save your answers directly in the file).</p><p>Verify that your exploits work; you will need to re-create <code>/home/httpd/grades.txt</code> after each successful exploit run.</p><p><strong>Testing</strong>: <code>make test_unlink_libc_1</code> and <code>make test_unlink_libc_2</code> will check that your exploits unlink <code>/home/httpd/grades.txt</code> with a non-executable stack. Note that this does <strong>not</strong> check <code>unlink_libc.txt</code>.</p><div class="alert-message block-message warning"><p class="admonition-title">Important</p><p>Although in principle you could use shellcode that's not located on the stack, for this task you should not inject any shellcode into the vulnerable process. You should use a return-to-libc (or at least a call-to-libc) attack where you divert control flow directly into <code>libc</code> code that existed before your attack.</p></div><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>The key observation to exploiting buffer overflows with a non-executable stack is that you still control the program counter, after a <code>RET</code> instruction jumps to an address that you placed on the stack. Even though you cannot jump to the address of the overflowed buffer (it will not be executable), there's usually enough code in the vulnerable server's address space to perform the operation you want.</p><p>Thus, to bypass a non-executable stack, you need to first find the code you want to execute. This is often a function in the standard library, called <code>libc</code>; examples of functions which are often useful are <code>execl</code>, <code>system</code>, or <code>unlink</code>. Then, you need to arrange for the stack to look like a call to that function with the desired arguments, such as <code>system("/bin/sh")</code>. Finally, you need to arrange for the <code>RET</code> instruction to jump to the function you found in the first step. This attack is often called a return-to-libc attack. The file <code>articles/return_to_libc.txt</code> contains a more detailed description of this style of attack.</p></div><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>You will need to understand the calling convention for C functions. For your reference, consider the following simple C program:</p><pre>void
foo(int x, char *msg, int y)
{
     /* ... */
}

void
bar(void)
{
    int a = 3;
    foo(5, "Hello, world!", 7);
}</pre><p>The stack layout when <code>bar()</code> invokes <code>foo()</code>, just after the program counter has switched to the beginning of <code>foo()</code>, looks like this:</p><pre>                +------------------+
   %ebp ------&gt; |    saved %ebp    | (4 bytes)
                +------------------+
                |       ...        |
                +------------------+
bar's a ------&gt; |        3         | (4 bytes)
                +------------------+
                |       ...        |
                +------------------+
                |        7         | (4 bytes)
                +------------------+
                |    pointer to    | ------&gt;  "Hello, world!", somewhere
                |      string      | (4 bytes)                 in memory
                +------------------+
                |        5         | (4 bytes)
                +------------------+
                |  return address  | (4 bytes)
   %esp ------&gt; |     into bar     |
                +------------------+
                |                  |</pre><p>When foo starts running, the first thing it will do is save the <code>%ebp</code> register on the stack, and set the <code>%ebp</code> register to point at this saved value on the stack, so the stack frame will look like the one shown <a class="reference internal" href="#foostack">for foo</a>.</p></div></section><section id="part-5-finding-other-vulnerabilities"><header><h3>Part 5: Finding Other Vulnerabilities</h3></header><p>Now that you have figured out how to exploit buffer overflows, you will try to find other kinds of vulnerabilities in the same code. As with many real-world applications, the "security" of our web server is not well-defined. Thus, you will need to use your imagination to think of a plausible threat model and policy for the web server.</p><p>Look through the source code and try to find more vulnerabilities that can allow an attacker to compromise the security of the web server. Describe the attacks you have found in <code>attacks.txt</code>, along with an explanation of the limitations of the attack, what an attacker can accomplish, why it works, and how you might go about fixing or preventing it. You should ignore bugs in <code>zoobar/</code>.</p><p>You should find at least two vulnerabilities for this exercise.</p><p><strong>Testing</strong>: on your own.</p><div class="alert-message block-message info"><p class="admonition-title">Tip</p><p>One approach for finding vulnerabilities is to trace the flow of inputs controlled by the attacker through the server code. At each point that the attacker's input is used, consider all the possible values that the attacker might have provided at that point; consider what the attacker can achieve.</p></div></section><section id="part-6-fixing-buffer-overflows"><header><h3>Part 6: Fixing Buffer Overflows</h3></header><p>Finally, you will explore fixing some of the vulnerabilities that you have found in this lab assignment. For each buffer overflow vulnerability you have found in <code>bugs.txt</code>, fix the web server's code to prevent the vulnerability in the first place. Above each modified code block, add a comment stating which bug from <code>bugs.txt</code> is fixed.</p><p>Commit these fixes directly to your branch. Don't worry about your fixes breaking your previous exploits, as the test scripts will always use the original (buggy) binaries.</p><p><strong>Testing</strong>: on your own.</p><div class="alert-message block-message warning"><p class="admonition-title">Caution</p><p>Do not rely on compile-time or runtime mechanisms such as stack canaries, removing <code>-fno-stack-protector</code>, baggy bounds checking, etc.</p></div></section></section><section id="submitting"><header><h2>Submitting</h2></header><div class="alert-message block-message warning"><p class="admonition-title">Important</p><p>Before submitting, make sure all your work is committed and pushed to the <code>submission</code> branch.</p></div><div class="alert-message block-message warning"><p class="admonition-title">Caution</p><p>Due to the specificity of the VM environment, there is no Travis build for this project. Thus, you need to be especially careful in making sure that <code>make test</code> succeeds locally (with all files committed and pushed).</p><p>If you want to make sure your submission is OK, here's how we're going to grade your code:</p><ul><li><p>Create a clean VM from the vm263 image.</p></li><li><p>Login and clone your repository.</p></li><li><p><code>make -k test</code></p></li></ul></div><p>After pushing, on the repo's GitHub page, click "Compare and pull request". Then, click on "Create pull request" to submit your work! The title can be whatever, and the comment can be left blank (or non-blank if you have a note for the grader).</p><p>If you need to edit your submission before the deadline, just commit and push your new changes to the your branch. The original pull request will be automatically updated with those commits (of course, be sure to check the GitHub pull request page to verify).</p><div class="alert-message block-message warning"><p class="admonition-title">Caution</p><p>Do <strong>not</strong> click "Merge pull request" after submitting, as this will modify the original repository. We will merge your pull request when grading.</p></div><div class="alert-message block-message warning"><p class="admonition-title">Caution</p><p>The deadlines for all assignments are on Canvas. Deadlines are enforced to the minute (the last commit before the deadline is considered the submission), and the course late policy is a 10% deduction per 8 hours of lateness.</p></div></section><section id="deliverables-and-rubric"><header><h2>Deliverables and Rubric</h2></header><p>"Script" grading means we will assign points based on the result of the relevant <code>make test_blah</code> command.</p><table><thead><tr><th><p>Criteria</p></th><th><p>Points</p></th><th><p>Grading method</p></th></tr></thead><tbody><tr><td><p><code>bugs.txt</code></p></td><td><p>15</p></td><td><p>Manual</p></td></tr><tr><td><p><code>crash_1.py</code> and <code>crash_2.py</code></p></td><td><p>16</p></td><td><p>Script</p></td></tr><tr><td><p><code>crash.txt</code></p></td><td><p>2</p></td><td><p>Manual</p></td></tr><tr><td><p><code>unlink_exstack.py</code></p></td><td><p>16</p></td><td><p>Script</p></td></tr><tr><td><p><code>unlink_exstack.txt</code></p></td><td><p>2</p></td><td><p>Manual</p></td></tr><tr><td><p><code>unlink_libc_1.py</code> and <code>unlink_libc_2.py</code></p></td><td><p>26</p></td><td><p>Script</p></td></tr><tr><td><p><code>unlink_libc.txt</code></p></td><td><p>4</p></td><td><p>Manual</p></td></tr><tr><td><p><code>attacks.txt</code></p></td><td><p>10</p></td><td><p>Manual</p></td></tr><tr><td><p>Buffer overflow fixes</p></td><td><p>9</p></td><td><p>Manual</p></td></tr></tbody></table></section><section id="acknowledgements"><header><h2>Acknowledgements</h2></header><p>This project was derived from one offered by MIT's 6.858 class.</p></section></body></html>